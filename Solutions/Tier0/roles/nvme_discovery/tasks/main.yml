---
# NVMe Discovery Role - Dynamically discover NVMe drives and group by NUMA node
# Excludes boot drive automatically for safe RAID configuration

- name: Initialize discovery variables
  ansible.builtin.set_fact:
    nvme_devices: []
    numa_nodes: []
    nvme_by_numa: {}
    discovered_raid_arrays: []
    discovered_mount_points: []
    discovered_nfs_exports: []
    _hs_clients: []
    raid_arrays: "{{ raid_arrays | default([]) }}"
    mount_points: "{{ mount_points | default([]) }}"
    nfs_exports: "{{ nfs_exports | default([]) }}"

# ============================================================================
# CPU-Optimized RAID Configuration
# ============================================================================
- name: Include CPU optimization tasks
  ansible.builtin.include_tasks: cpu_optimization.yml
  when: cpu_optimized_raid | default(true)

- name: Identify boot device (device containing root filesystem)
  ansible.builtin.shell: |
    lsblk -no PKNAME "$(findmnt -n -o SOURCE /)" 2>/dev/null | head -1
  register: boot_device_raw
  changed_when: false

- name: Set boot device fact
  ansible.builtin.set_fact:
    boot_device: "{{ boot_device_raw.stdout | default('') | trim }}"

- name: Display boot device
  ansible.builtin.debug:
    msg: "Boot device detected: {{ boot_device }} (will be excluded from RAID)"

- name: Discover all NVMe devices with NUMA node, serial, model, and PCIe address
  ansible.builtin.shell: |
    for nvme in /sys/class/nvme/nvme*; do
      if [ -d "$nvme" ]; then
        name=$(basename "$nvme")
        numa=$(cat "$nvme/device/numa_node" 2>/dev/null || echo "-1")
        serial=$(cat "$nvme/serial" 2>/dev/null | xargs || echo "unknown")
        model=$(cat "$nvme/model" 2>/dev/null | xargs || echo "unknown")
        pcie=$(cat "$nvme/address" 2>/dev/null | xargs || echo "unknown")
        # Check if the namespace exists (nvmeXn1)
        if [ -b "/dev/${name}n1" ]; then
          echo "${name}:${numa}:${serial}:${model}:${pcie}"
        fi
      fi
    done
  register: nvme_numa_raw
  changed_when: false

- name: Initialize excluded devices list
  ansible.builtin.set_fact:
    nvme_excluded_devices: []

- name: Build NVMe device list with full info
  ansible.builtin.set_fact:
    nvme_all_devices: >-
      {{
        nvme_all_devices | default([]) + [{
          'name': item.split(':')[0],
          'device': '/dev/' + item.split(':')[0] + 'n1',
          'numa': item.split(':')[1] | int,
          'serial': item.split(':')[2],
          'model': item.split(':')[3],
          'pcie_address': ':'.join(item.split(':')[4:])
        }]
      }}
  loop: "{{ nvme_numa_raw.stdout_lines | default([]) }}"
  when: item | length > 0

- name: Apply exclusion rules
  ansible.builtin.set_fact:
    nvme_devices: >-
      {{
        nvme_all_devices | default([]) | rejectattr('name', 'equalto', boot_device)
        | rejectattr('name', 'in', nvme_exclude_devices | default([]) | map('regex_replace', 'n1$', '') | list)
        | rejectattr('device', 'in', nvme_exclude_paths | default([]))
        | rejectattr('serial', 'in', nvme_exclude_serials | default([]))
        | rejectattr('numa', 'in', nvme_exclude_numa_nodes | default([]))
        | rejectattr('pcie_address', 'in', nvme_exclude_pcie_addresses | default([]))
        | list
      }}

- name: Apply model exclusion
  ansible.builtin.set_fact:
    nvme_devices: >-
      {{
        nvme_devices | rejectattr('model', 'in', nvme_exclude_models | default([])) | list
      }}
  when: nvme_exclude_models | default([]) | length > 0

- name: Apply PCIe prefix exclusion
  ansible.builtin.set_fact:
    nvme_devices: >-
      {{
        nvme_devices | rejectattr('pcie_address', 'match', '^(' + nvme_exclude_pcie_prefixes | join('|') + ')') | list
      }}
  when: nvme_exclude_pcie_prefixes | default([]) | length > 0

- name: Build excluded devices list for reporting
  ansible.builtin.set_fact:
    nvme_excluded_devices: >-
      {{
        nvme_all_devices | default([]) | difference(nvme_devices) | list
      }}

- name: Display exclusion information
  ansible.builtin.debug:
    msg: |
      NVMe Exclusion Summary:
      ============================================
      Boot device (always excluded): {{ boot_device }}
      Excluded by device name: {{ nvme_exclude_devices | default([]) | join(', ') | default('none', true) }}
      Excluded by path: {{ nvme_exclude_paths | default([]) | join(', ') | default('none', true) }}
      Excluded by serial: {{ nvme_exclude_serials | default([]) | join(', ') | default('none', true) }}
      Excluded by model: {{ nvme_exclude_models | default([]) | join(', ') | default('none', true) }}
      Excluded by NUMA node: {{ nvme_exclude_numa_nodes | default([]) | join(', ') | default('none', true) }}
      Excluded by PCIe address: {{ nvme_exclude_pcie_addresses | default([]) | join(', ') | default('none', true) }}
      Excluded by PCIe prefix: {{ nvme_exclude_pcie_prefixes | default([]) | join(', ') | default('none', true) }}

      Devices excluded from RAID:
      {% for dev in nvme_excluded_devices %}
        - {{ dev.device }} ({{ dev.model }}, Serial: {{ dev.serial }}, NUMA: {{ dev.numa }}, PCIe: {{ dev.pcie_address }})
      {% endfor %}
      {% if nvme_excluded_devices | length == 0 %}
        (none - only boot device excluded)
      {% endif %}
      ============================================
  when: nvme_exclude_devices | default([]) | length > 0 or
        nvme_exclude_paths | default([]) | length > 0 or
        nvme_exclude_serials | default([]) | length > 0 or
        nvme_exclude_models | default([]) | length > 0 or
        nvme_exclude_numa_nodes | default([]) | length > 0 or
        nvme_exclude_pcie_addresses | default([]) | length > 0 or
        nvme_exclude_pcie_prefixes | default([]) | length > 0

- name: Get unique NUMA nodes
  ansible.builtin.set_fact:
    numa_nodes: "{{ nvme_devices | map(attribute='numa') | unique | sort | list }}"

- name: Group NVMe devices by NUMA node
  ansible.builtin.set_fact:
    nvme_by_numa: >-
      {{
        nvme_by_numa | default({}) | combine({
          item | string: nvme_devices | selectattr('numa', 'equalto', item) | map(attribute='device') | list
        })
      }}
  loop: "{{ numa_nodes }}"

- name: Display discovered NVMe configuration
  ansible.builtin.debug:
    msg: |
      ============================================
      NVMe DISCOVERY RESULTS
      ============================================
      Boot device (excluded): {{ boot_device }}
      Total NVMe devices for RAID: {{ nvme_devices | length }}
      Excluded devices: {{ nvme_excluded_devices | length }}
      NUMA nodes detected: {{ numa_nodes | join(', ') }}

      Devices by NUMA node:
      {% for numa in numa_nodes %}
      NUMA {{ numa }}: {{ nvme_by_numa[numa | string] | join(', ') }}
      {% endfor %}

      Device Details:
      {% for dev in nvme_devices %}
        {{ dev.device }}: {{ dev.model }} (Serial: {{ dev.serial }}, NUMA: {{ dev.numa }}, PCIe: {{ dev.pcie_address }})
      {% endfor %}
      ============================================

# ============================================================================
# Build RAID Arrays (with sizing options)
# ============================================================================
- name: Include RAID array building tasks
  ansible.builtin.include_tasks: build_raid_arrays.yml

- name: Override raid_arrays with discovered configuration
  ansible.builtin.set_fact:
    raid_arrays: "{{ discovered_raid_arrays }}"
  when:
    - use_dynamic_discovery | default(true)
    - raid_grouping_strategy | default('numa') != 'per_drive'

- name: Override mount_points with discovered configuration
  ansible.builtin.set_fact:
    mount_points: "{{ discovered_mount_points }}"
  when: use_dynamic_discovery | default(true)

- name: Initialize NFS client list
  ansible.builtin.set_fact:
    _hs_clients: []

- name: Add Hammerspace nodes to NFS client list
  ansible.builtin.set_fact:
    _hs_clients: "{{ _hs_clients + [{'host': item, 'options': hammerspace_export_opts | default('rw,no_root_squash,sync,secure,mp,no_subtree_check')}] }}"
  loop: "{{ (hammerspace_nodes | default([])) + (mover_nodes | default([])) }}"

- name: Add client subnets to NFS client list
  ansible.builtin.set_fact:
    _hs_clients: "{{ _hs_clients + [{'host': item, 'options': client_export_opts | default('rw,root_squash,sync,secure,mp,no_subtree_check')}] }}"
  loop: "{{ client_subnets | default([]) }}"

- name: Build dynamic NFS exports for discovered mount points
  ansible.builtin.set_fact:
    discovered_nfs_exports: "{{ discovered_nfs_exports | default([]) + [{'path': item.path, 'clients': _hs_clients}] }}"
  loop: "{{ discovered_mount_points }}"
  when: use_dynamic_discovery | default(true)

- name: Override nfs_exports with discovered configuration
  ansible.builtin.set_fact:
    nfs_exports: "{{ discovered_nfs_exports }}"
  when:
    - use_dynamic_discovery | default(true)
    - discovered_nfs_exports is defined
    - discovered_nfs_exports | length > 0

- name: Display final RAID configuration
  ansible.builtin.debug:
    msg: |
      ============================================
      DYNAMIC RAID CONFIGURATION
      ============================================
      {% for array in raid_arrays %}
      {{ array.name }} ({{ array.device }}):
        NUMA Node: {{ array.numa_node | default('N/A') }}
        RAID Level: {{ array.level }}
        Drives ({{ array.drives | length }}): {{ array.drives | join(', ') }}
      {% endfor %}
      ============================================

      Mount Points:
      {% for mp in mount_points %}
      {{ mp.path }} -> {{ mp.device }} ({{ mp.fstype }})
      {% endfor %}
      ============================================

      NFS Exports: {{ nfs_exports | length }} paths configured
      ============================================
