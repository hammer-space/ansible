# iptables configuration tasks (fallback for systems without firewalld/ufw)

- name: Flush iptables rules
  ansible.builtin.iptables:
    flush: true
    chain: "{{ item }}"
  loop:
    - INPUT
    - FORWARD
    - OUTPUT
  when: flush_iptables | default(true)
  ignore_errors: true

- name: Set default INPUT policy to ACCEPT
  ansible.builtin.iptables:
    chain: INPUT
    policy: ACCEPT
  when: flush_iptables | default(true)
  ignore_errors: true

- name: Allow established connections
  ansible.builtin.iptables:
    chain: INPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT
  ignore_errors: true

- name: Allow SSH
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 22
    jump: ACCEPT
    comment: "SSH"
  ignore_errors: true

- name: Allow NFS ports through iptables
  ansible.builtin.iptables:
    chain: INPUT
    protocol: "{{ item.proto }}"
    destination_port: "{{ item.port }}"
    jump: ACCEPT
    comment: "NFS - {{ item.service }}"
  loop: "{{ nfs_ports }}"
  ignore_errors: true

- name: Allow custom ports if specified
  ansible.builtin.iptables:
    chain: INPUT
    protocol: "{{ item.proto }}"
    destination_port: "{{ item.port }}"
    jump: ACCEPT
    comment: "NFS custom - {{ item.service | default('custom') }}"
  loop: "{{ custom_nfs_ports | default([]) }}"
  when: custom_nfs_ports is defined
  ignore_errors: true

- name: Save iptables rules (RHEL/CentOS)
  ansible.builtin.command: service iptables save
  changed_when: true
  failed_when: false
  when: ansible_os_family == 'RedHat'

- name: Save iptables rules (Debian/Ubuntu)
  ansible.builtin.shell: iptables-save > /etc/iptables/rules.v4
  changed_when: true
  failed_when: false
  when: ansible_os_family == 'Debian'

- name: Display iptables rules
  ansible.builtin.command: iptables -L -n
  register: iptables_rules
  changed_when: false
  failed_when: false

- name: Show iptables configuration
  ansible.builtin.debug:
    var: iptables_rules.stdout_lines
