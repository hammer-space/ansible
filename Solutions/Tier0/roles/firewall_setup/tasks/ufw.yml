---
# UFW configuration tasks (Debian/Ubuntu)

- name: Ensure ufw is installed
  ansible.builtin.package:
    name: ufw
    state: present

- name: Allow NFS ports through UFW
  community.general.ufw:
    rule: allow
    port: "{{ item.port | string }}"
    proto: "{{ item.proto }}"
    comment: "NFS - {{ item.service }}"
  loop: "{{ nfs_ports }}"

- name: Allow custom ports if specified in nfs.conf
  community.general.ufw:
    rule: allow
    port: "{{ item.port | string }}"
    proto: "{{ item.proto }}"
    comment: "NFS custom - {{ item.service | default('custom') }}"
  loop: "{{ custom_nfs_ports | default([]) }}"
  when: custom_nfs_ports is defined

- name: Enable UFW
  community.general.ufw:
    state: enabled
    policy: deny
  when: enable_ufw | default(false)

- name: Verify UFW status
  ansible.builtin.command: ufw status verbose
  register: ufw_status
  changed_when: false

- name: Display UFW configuration
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
