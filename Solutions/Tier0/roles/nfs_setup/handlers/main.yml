---
# Handlers for nfs_setup role

- name: Reload NFS exports
  ansible.builtin.command: exportfs -ra

- name: Mount rpc_pipefs
  ansible.builtin.shell: |
    modprobe sunrpc 2>/dev/null || true
    if ! mountpoint -q /var/lib/nfs/rpc_pipefs 2>/dev/null; then
      mkdir -p /var/lib/nfs/rpc_pipefs
      mount -t rpc_pipefs sunrpc /var/lib/nfs/rpc_pipefs 2>/dev/null || true
    fi
  changed_when: false
  listen: "Restart NFS server"
  when: not (node_already_in_hammerspace | default(false))

- name: Restart rpcbind for NFS
  ansible.builtin.systemd:
    name: rpcbind
    state: restarted
  ignore_errors: true
  listen: "Restart NFS server"
  when: not (node_already_in_hammerspace | default(false))

- name: Restart NFS service
  ansible.builtin.shell: |
    systemctl restart nfs-kernel-server 2>/dev/null || \
    systemctl restart nfs-server 2>/dev/null || \
    service nfs-kernel-server restart 2>/dev/null || \
    service nfs restart 2>/dev/null || \
    echo "NFS restart attempted"
  register: nfs_restart_result
  changed_when: true
  failed_when: false
  listen: "Restart NFS server"
  when: not (node_already_in_hammerspace | default(false))

- name: Verify NFS is running
  ansible.builtin.shell: |
    systemctl is-active nfs-kernel-server 2>/dev/null || \
    systemctl is-active nfs-server 2>/dev/null || \
    pgrep -x nfsd >/dev/null
  register: nfs_check
  changed_when: false
  failed_when: nfs_check.rc != 0
  listen: "Restart NFS server"
  when: not (node_already_in_hammerspace | default(false))

- name: Skip NFS restart (node already in Hammerspace)
  ansible.builtin.debug:
    msg: "Skipping NFS service restart - node is already registered in Hammerspace"
  listen: "Restart NFS server"
  when: node_already_in_hammerspace | default(false)

- name: Restart rpcbind
  ansible.builtin.systemd:
    name: rpcbind
    state: restarted

- name: Reload udev rules
  ansible.builtin.shell: |
    udevadm control --reload-rules
    udevadm trigger --subsystem-match=bdi
  changed_when: true

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
