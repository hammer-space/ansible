---
# Mount Point Protection Tasks
# Deploys systemd guard services and auto-remount watchdog
# Based on Hammerspace "Protecting Linux Mount Points with systemd" guide

- name: Initialize mount protection units list
  ansible.builtin.set_fact:
    mount_protection_units: []

- name: Build mount unit names from paths
  ansible.builtin.set_fact:
    mount_protection_units: >-
      {{
        mount_protection_units + [{
          'path': item.path,
          'name': item.path | basename,
          'mount_unit': item.path | regex_replace('^/', '') | regex_replace('/', '-')
        }]
      }}
  loop: "{{ mount_points_with_uuid | default([]) }}"
  loop_control:
    label: "{{ item.path }}"

- name: Debug mount protection units
  ansible.builtin.debug:
    var: mount_protection_units
  when: hammerspace_debug | default(false)

# ============================================================================
# Guards Target
# ============================================================================

- name: Deploy hammerspace-guards.target
  ansible.builtin.template:
    src: hammerspace-guards.target.j2
    dest: /etc/systemd/system/hammerspace-guards.target
    owner: root
    group: root
    mode: '0644'
  notify: Reload systemd daemon

# ============================================================================
# Guard Services (one per mount point)
# ============================================================================

- name: Deploy guard services for each mount point
  ansible.builtin.template:
    src: hammerspace-guard.service.j2
    dest: "/etc/systemd/system/hammerspace-{{ item.name }}-guard.service"
    owner: root
    group: root
    mode: '0644'
  vars:
    mount_path: "{{ item.path }}"
    mount_name: "{{ item.name }}"
    mount_unit: "{{ item.mount_unit }}"
  loop: "{{ mount_protection_units | default([]) }}"
  loop_control:
    label: "{{ item.path }}"
  when:
    - hammerspace_mount_guard_enabled | default(true)
    - mount_protection_units | default([]) | length > 0
  notify: Reload systemd daemon

# ============================================================================
# Auto-Remount Watchdog
# ============================================================================

- name: Deploy remount check script
  ansible.builtin.template:
    src: hammerspace-remount-check.sh.j2
    dest: /usr/local/bin/hammerspace-remount-check.sh
    owner: root
    group: root
    mode: '0755'
  when: hammerspace_remount_watchdog_enabled | default(true)

- name: Deploy remount watchdog service
  ansible.builtin.template:
    src: hammerspace-remount.service.j2
    dest: /etc/systemd/system/hammerspace-remount.service
    owner: root
    group: root
    mode: '0644'
  when: hammerspace_remount_watchdog_enabled | default(true)
  notify: Reload systemd daemon

- name: Deploy remount watchdog timer
  ansible.builtin.template:
    src: hammerspace-remount.timer.j2
    dest: /etc/systemd/system/hammerspace-remount.timer
    owner: root
    group: root
    mode: '0644'
  when: hammerspace_remount_watchdog_enabled | default(true)
  notify: Reload systemd daemon

# ============================================================================
# Enable and Start Services
# ============================================================================

- name: Flush handlers to reload systemd
  ansible.builtin.meta: flush_handlers

- name: Reload systemd daemon immediately
  ansible.builtin.systemd:
    daemon_reload: true

- name: Verify hammerspace-guards.target exists
  ansible.builtin.stat:
    path: /etc/systemd/system/hammerspace-guards.target
  register: guards_target_stat

- name: Debug guards target status
  ansible.builtin.debug:
    msg: "Guards target exists: {{ guards_target_stat.stat.exists | default(false) }}"

- name: Enable and start hammerspace-guards.target
  ansible.builtin.systemd:
    name: hammerspace-guards.target
    enabled: true
    state: started
  when:
    - hammerspace_mount_guard_enabled | default(true)
    - guards_target_stat.stat.exists | default(false)
    - not ansible_check_mode

- name: Check guard service files exist
  ansible.builtin.stat:
    path: "/etc/systemd/system/hammerspace-{{ item.name }}-guard.service"
  loop: "{{ mount_protection_units | default([]) }}"
  loop_control:
    label: "{{ item.path }}"
  register: guard_service_stats
  when: mount_protection_units | default([]) | length > 0

- name: Enable and start guard services
  ansible.builtin.systemd:
    name: "hammerspace-{{ item.item.name }}-guard.service"
    enabled: true
    state: started
  loop: "{{ guard_service_stats.results | default([]) }}"
  loop_control:
    label: "{{ item.item.path | default('unknown') }}"
  when:
    - hammerspace_mount_guard_enabled | default(true)
    - item.stat.exists | default(false)
    - not ansible_check_mode

- name: Check remount timer exists
  ansible.builtin.stat:
    path: /etc/systemd/system/hammerspace-remount.timer
  register: remount_timer_stat
  when: hammerspace_remount_watchdog_enabled | default(true)

- name: Enable and start remount watchdog timer
  ansible.builtin.systemd:
    name: hammerspace-remount.timer
    enabled: true
    state: started
  when:
    - hammerspace_remount_watchdog_enabled | default(true)
    - remount_timer_stat.stat.exists | default(false)
    - not ansible_check_mode

- name: Display mount protection status (check mode)
  ansible.builtin.debug:
    msg: |
      Mount Protection (CHECK MODE - services not started):
      =====================================================
      Guard services: {{ 'will be enabled' if hammerspace_mount_guard_enabled | default(true) else 'disabled' }}
      Remount watchdog: {{ 'will be enabled' if hammerspace_remount_watchdog_enabled | default(true) else 'disabled' }}
      Mounts to protect:
      {% for unit in mount_protection_units | default([]) %}
        - {{ unit.path }} (guard: hammerspace-{{ unit.name }}-guard.service)
      {% endfor %}
  when:
    - mount_protection_units | default([]) | length > 0
    - ansible_check_mode

- name: Display mount protection status
  ansible.builtin.debug:
    msg: |
      Mount Protection Deployed:
      ==========================
      Guard services: {{ 'enabled' if hammerspace_mount_guard_enabled | default(true) else 'disabled' }}
      Remount watchdog: {{ 'enabled' if hammerspace_remount_watchdog_enabled | default(true) else 'disabled' }}
      Protected mounts:
      {% for unit in mount_protection_units | default([]) %}
        - {{ unit.path }} (guard: hammerspace-{{ unit.name }}-guard.service)
      {% endfor %}
  when:
    - mount_protection_units | default([]) | length > 0
    - not ansible_check_mode
