---
# Filesystem setup role - main tasks

- name: Initialize filesystem variables
  ansible.builtin.set_fact:
    mount_points_with_uuid: []

- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}.yml"
    - "{{ ansible_distribution | lower }}.yml"
    - "{{ ansible_os_family | lower }}.yml"
    - "default.yml"

- name: Install filesystem tools
  ansible.builtin.package:
    name: "{{ fs_packages }}"
    state: present

- name: Create mount point directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    mode: '0755'
  loop: "{{ mount_points }}"
  loop_control:
    label: "{{ item.path }}"
- name: Check if filesystem already exists on RAID device
  ansible.builtin.command: "blkid -o value -s TYPE {{ item.device }}"
  loop: "{{ mount_points }}"
  loop_control:
    label: "{{ item.device }}"
  register: fs_check
  changed_when: false
  failed_when: false

- name: Create XFS filesystem with Hammerspace-recommended options
  ansible.builtin.command: >-
    mkfs.xfs -f
    {% if xfs_agcount is defined and xfs_agcount %}-d agcount={{ xfs_agcount }}{% endif %}
    -L {{ item.item.label }} {{ item.item.device }}
  loop: "{{ fs_check.results }}"
  loop_control:
    label: "{{ item.item.device }}"
  when:
    - item.item.fstype == 'xfs'
    - item.stdout != 'xfs'
    - force_fs_recreate | default(false) or item.stdout != 'xfs'

- name: Create ext4 filesystem
  ansible.builtin.command: "mkfs.ext4 -F -L {{ item.item.label }} {{ item.item.device }}"
  loop: "{{ fs_check.results }}"
  loop_control:
    label: "{{ item.item.device }}"
  when:
    - item.item.fstype == 'ext4'
    - item.stdout != 'ext4'
    - force_fs_recreate | default(false) or item.stdout != 'ext4'

- name: Get filesystem UUIDs for fstab
  ansible.builtin.command: "blkid -s UUID -o value {{ item.device }}"
  loop: "{{ mount_points }}"
  loop_control:
    label: "{{ item.device }}"
  register: fs_uuids
  changed_when: false

- name: Build mount points with UUIDs
  ansible.builtin.set_fact:
    mount_points_with_uuid: >-
      {{
        mount_points_with_uuid | default([]) + [{
          'path': item.item.path,
          'uuid': item.stdout,
          'device': item.item.device,
          'fstype': item.item.fstype,
          'label': item.item.label,
          'mount_opts': item.item.mount_opts
        }]
      }}
  loop: "{{ fs_uuids.results }}"
  loop_control:
    label: "{{ item.item.device }}"

- name: Display UUID mappings
  ansible.builtin.debug:
    msg: "{{ item.device }} -> UUID={{ item.uuid }} -> {{ item.path }}"
  loop: "{{ mount_points_with_uuid }}"
  loop_control:
    label: "{{ item.path }}"

- name: Build mount options with automount protection
  ansible.builtin.set_fact:
    automount_opts: "nofail,x-systemd.automount,x-systemd.device-timeout={{ hammerspace_automount_timeout | default(10) }}"
  when: hammerspace_mount_protection | default(false)

- name: Mount filesystems using UUID
  ansible.posix.mount:
    path: "{{ item.path }}"
    src: "UUID={{ item.uuid }}"
    fstype: "{{ item.fstype }}"
    opts: "{{ item.mount_opts }}{% if hammerspace_mount_protection | default(false) %},{{ automount_opts }}{% endif %}"
    state: mounted
  loop: "{{ mount_points_with_uuid }}"
  loop_control:
    label: "{{ item.path }}"

- name: Verify mounts
  ansible.builtin.command: df -h
  register: df_output
  changed_when: false

- name: Display mount status
  ansible.builtin.debug:
    var: df_output.stdout_lines

# ============================================================================
# Mount Point Protection (systemd guards + auto-remount watchdog)
# ============================================================================

- name: Include mount protection tasks
  ansible.builtin.include_tasks: mount_protection.yml
  when: hammerspace_mount_protection | default(false)
