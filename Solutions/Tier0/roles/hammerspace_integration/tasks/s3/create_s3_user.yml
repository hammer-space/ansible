---
# Create S3 User with access credentials
# Called from main.yml with s3_user_config variable
# Reference: hs_ops s3_server_create_user.yml

- name: "Get current S3 server configuration"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/s3server"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: s3_server_info
  retries: 20
  delay: 5
  until: s3_server_info.status == 200

- name: "Build S3 user payload for {{ s3_user_config.name }}"
  ansible.builtin.set_fact:
    s3_user_payload:
      username: "{{ s3_user_config.name }}"
      userAccessKey: "{{ s3_user_config.access_key_id }}"
      userSecretKey: "{{ s3_user_config.secret_access_key }}"
      enabled: "{{ s3_user_config.enabled | default(true) }}"

- name: "Check if S3 user {{ s3_user_config.name }} already exists"
  ansible.builtin.set_fact:
    s3_user_exists: "{{ s3_user_config.name in (s3_server_info.json.users | default([]) | map(attribute='username') | list) }}"
  when: s3_server_info.json is defined

- name: "Add S3 user {{ s3_user_config.name }}"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/s3server/{{ s3_server_info.json.uoid.uuid }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: PUT
    body: "{{ s3_server_info.json | combine({'users': (s3_server_info.json.users | default([])) + [s3_user_payload]}, recursive=True) }}"
    body_format: json
    force_basic_auth: true
    status_code: [200, 202]
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 180
  register: s3_user_create_result
  when:
    - s3_server_info.json is defined
    - not (s3_user_exists | default(false))

- name: "Display S3 user status"
  ansible.builtin.debug:
    msg: >-
      S3 User '{{ s3_user_config.name }}'
      {% if s3_user_exists | default(false) %}already exists{% else %}created successfully{% endif %}
