---
# Add Object Storage Volume (S3 bucket)
# Called from main.yml with object_volume_config variable
# Reference: hs_ops add_object_storage_volume.yml

- name: "Wait for task queue before adding object volume {{ object_volume_config.name }}"
  ansible.builtin.include_tasks: ../task_queue_wait.yml
  when: hammerspace_task_queue_throttle | default(true)

- name: "Build object storage volume payload for {{ object_volume_config.name }}"
  ansible.builtin.set_fact:
    object_volume_payload:
      _type: "OBJECT_STORAGE_VOLUME"
      name: "{{ object_volume_config.node_name }}:{{ object_volume_config.bucket_name }}"
      objectStoreLogicalVolume:
        _type: "OBJECT_STORE_LOGICAL_VOLUME"
        name: "{{ object_volume_config.bucket_name }}"
        node:
          _type: "NODE"
          name: "{{ object_volume_config.node_name }}"
      node:
        _type: "NODE"
        name: "{{ object_volume_config.node_name }}"
      shared: "{{ object_volume_config.shared | default(true) }}"
      compressionType: "{{ object_volume_config.compression | default('NO_COMPRESSION') }}"

- name: "Check if object storage volume {{ object_volume_config.name }} already exists"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/object-storage-volumes/{{ object_volume_payload.name | urlencode }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: [200, 404]
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: object_volume_check
  failed_when: false

- name: "Add object storage volume {{ object_volume_config.name }}"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/object-storage-volumes"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: POST
    body: "{{ object_volume_payload }}"
    body_format: json
    force_basic_auth: true
    status_code: [200, 202]
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 180
  register: object_volume_add_result
  when: object_volume_check.status == 404

- name: "Wait for object storage volume add to complete"
  ansible.builtin.uri:
    url: "{{ object_volume_add_result.location }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
  register: object_volume_add_status
  until: object_volume_add_status.json.status == "COMPLETED"
  retries: 20
  delay: 5
  when: object_volume_add_result.location is defined

- name: "Display object storage volume status"
  ansible.builtin.debug:
    msg: >-
      Object Storage Volume '{{ object_volume_payload.name }}'
      {% if object_volume_check.status == 200 %}already exists{% else %}added successfully{% endif %}
