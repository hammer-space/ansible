---
# Enable Prometheus Monitoring Exporters
# Called from main.yml with prometheus_config variable (optional)
# Reference: hs_ops prometheus_exporters_enable.yml

- name: "Get current cluster controller configuration"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/cntl"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: current_cntl

- name: "Check if Prometheus is already enabled"
  ansible.builtin.set_fact:
    prometheus_already_enabled: "{{ current_cntl.json[0].prometheusExportersEnabled | default(false) }}"
  when: current_cntl.json | length > 0

- name: "Build Prometheus config payload"
  ansible.builtin.set_fact:
    prometheus_payload:
      prometheusExportersEnabled: true
      prometheusExporterPort: "{{ prometheus_config.port | default(9100) }}"

- name: "Enable Prometheus exporters"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/cntl/{{ current_cntl.json[0].uoid.uuid }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: PUT
    body: "{{ current_cntl.json[0] | combine(prometheus_payload, recursive=True) }}"
    body_format: json
    force_basic_auth: true
    status_code: [200, 202]
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 180
  register: prometheus_enable_result
  when:
    - current_cntl.json | length > 0
    - not (prometheus_already_enabled | default(false))

- name: "Wait for Prometheus enable to complete"
  ansible.builtin.uri:
    url: "{{ prometheus_enable_result.location }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
  register: prometheus_status
  until: prometheus_status.json.status == "COMPLETED"
  retries: 30
  delay: 5
  when: prometheus_enable_result.location is defined

- name: "Display Prometheus status"
  ansible.builtin.debug:
    msg: >-
      Prometheus exporters:
      {% if prometheus_already_enabled | default(false) %}already enabled{% else %}enabled on port {{ prometheus_config.port | default(9100) }}{% endif %}
