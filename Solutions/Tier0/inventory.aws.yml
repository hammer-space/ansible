---
# AWS Dynamic Inventory for Ansible
# Prerequisites:
#   ansible-galaxy collection install amazon.aws
#   pip3 install boto3 botocore
#   Configure AWS credentials (~/.aws/credentials or environment variables)
#
# Authentication options:
#   Option 1: AWS CLI - run 'aws configure'
#   Option 2: Environment variables:
#     export AWS_ACCESS_KEY_ID='your-key'
#     export AWS_SECRET_ACCESS_KEY='your-secret'
#     export AWS_REGION='us-west-2'
#   Option 3: IAM role (when running on EC2)
#
# Test with: ansible-inventory -i inventory.aws.yml --list

plugin: amazon.aws.aws_ec2
regions:
  - us-west-2
  # Add more regions as needed
  # - us-east-1
  # - eu-west-1

# AWS credentials (optional - uses default credential chain if not specified)
# aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
# aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"

# Assume role (optional - for cross-account access)
# iam_role_arn: arn:aws:iam::123456789012:role/AnsibleRole

hostname_format_preferences:
  - "tag:Name"
  - "private-ip-address"

# Filter to only running instances
# Adjust filters based on your tagging convention
filters:
  instance-state-name: running
  # Filter by tag - uncomment and adjust as needed
  # tag:Environment: tier0
  # tag:Role: storage
  # Filter by instance type (GPU instances)
  # instance-type:
  #   - p4d.24xlarge
  #   - p5.48xlarge
  #   - g5.48xlarge

# Create storage_servers group based on tags
groups:
  storage_servers: "'tier0' in (tags.Role | default('')) or 'storage' in (tags.Role | default(''))"

# Set connection variables and expose AWS metadata
compose:
  ansible_host: private_ip_address
  ansible_user: "'ubuntu'"
  ansible_python_interpreter: "'/usr/bin/python3'"
  ansible_become: true
  # AWS metadata
  aws_instance_id: instance_id
  aws_instance_type: instance_type
  aws_availability_zone: placement.availability_zone
  aws_region: placement.region
  aws_subnet_id: subnet_id
  aws_vpc_id: vpc_id
  aws_private_ip: private_ip_address
  aws_public_ip: public_ip_address | default('')
  aws_launch_time: launch_time
  aws_image_id: image_id
  # Instance tags as variables
  aws_tags: tags
  aws_name: tags.Name | default(instance_id)
  # CPU and memory info
  aws_cpu_options: cpu_options | default({})
  aws_ebs_optimized: ebs_optimized | default(false)
  # Hammerspace AZ prefix derived from availability zone
  # us-west-2a -> "AZ1:", us-west-2b -> "AZ2:", us-west-2c -> "AZ3:", etc.
  hammerspace_volume_az_prefix: >-
    "AZ" ~ ((placement.availability_zone[-1:] | lower | ord) - 96) ~ ":"

# Create groups based on availability zone, instance type, and tags
keyed_groups:
  # Group by availability zone (e.g., az_us-west-2a)
  - key: placement.availability_zone
    prefix: az
    separator: "_"
  # Group by instance type (e.g., type_p4d_24xlarge)
  - key: instance_type | replace('.', '_')
    prefix: type
    separator: "_"
  # Group by Environment tag (e.g., env_production)
  - key: tags.Environment | default('untagged')
    prefix: env
    separator: "_"
  # Group by VPC (e.g., vpc_vpc-12345678)
  - key: vpc_id
    prefix: vpc
    separator: "_"
  # Group by region (e.g., region_us-west-2)
  - key: placement.region
    prefix: region
    separator: "_"
