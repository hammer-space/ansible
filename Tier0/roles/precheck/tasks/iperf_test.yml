---
# iperf/iperf3 Bandwidth Test
# Tests network bandwidth between Tier 0 instances and Hammerspace nodes
#
# Configuration (vars/main.yml):
#   iperf_version: "iperf" or "iperf3" (default: iperf3)
#   iperf_test_targets: list of target IPs
#   iperf_test_duration: test duration in seconds (default: 10)
#   iperf_test_parallel: parallel streams (default: 16 for 200Gbps+)
#   iperf_min_bandwidth_mbps: minimum expected bandwidth (default: 180000)
#
# Server requirements:
#   iperf:  iperf -s -D (port 5001)
#   iperf3: iperf3 -s -D (port 5201)

- name: Set iperf version and package name
  ansible.builtin.set_fact:
    _iperf_version: "{{ iperf_version | default('iperf3') }}"
    _iperf_package: "{{ 'iperf3' if (iperf_version | default('iperf3')) == 'iperf3' else 'iperf' }}"
    _iperf_port: "{{ '5201' if (iperf_version | default('iperf3')) == 'iperf3' else '5001' }}"

- name: Check if {{ _iperf_version }} is installed
  ansible.builtin.command: "which {{ _iperf_version }}"
  register: iperf_check
  changed_when: false
  failed_when: false

- name: Install {{ _iperf_package }} package
  ansible.builtin.package:
    name: "{{ _iperf_package }}"
    state: present
  when: iperf_check.rc != 0

- name: Initialize iperf results
  ansible.builtin.set_fact:
    iperf_results: []

# ============================================================================
# iperf3 test (JSON output for reliable parsing)
# ============================================================================
- name: Run iperf3 bandwidth test to each target
  ansible.builtin.shell: |
    {{ _iperf_version }} -c {{ item }} -t {{ iperf_test_duration | default(10) }} -P {{ iperf_test_parallel | default(16) }} -J 2>&1
  loop: "{{ iperf_test_targets | default([]) }}"
  register: iperf3_raw_results
  changed_when: false
  failed_when: false
  when:
    - _iperf_version == 'iperf3'
    - iperf_test_targets | default([]) | length > 0

- name: Parse iperf3 results (JSON)
  ansible.builtin.set_fact:
    iperf_results: >-
      {{
        iperf_results + [{
          'target': item.item,
          'success': item.rc == 0 and 'error' not in item.stdout,
          'bandwidth_mbps': ((item.stdout | from_json).end.sum_sent.bits_per_second | default(0) / 1000000) | round(2) if item.rc == 0 and 'error' not in item.stdout and (item.stdout | from_json).end is defined else '0',
          'output': (item.stdout | from_json).end.sum_sent.bits_per_second | default(0) | int | string + ' bits/sec' if item.rc == 0 and 'error' not in item.stdout and (item.stdout | from_json).end is defined else item.stdout_lines | default([]) | last | default('No output'),
          'error': (item.stdout | from_json).error | default('') if item.rc != 0 or 'error' in item.stdout else ''
        }]
      }}
  loop: "{{ iperf3_raw_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item | default('unknown') }}"
  when:
    - _iperf_version == 'iperf3'
    - iperf3_raw_results.results is defined

# ============================================================================
# iperf (legacy) test
# ============================================================================
- name: Run iperf bandwidth test to each target
  ansible.builtin.shell: |
    {{ _iperf_version }} -c {{ item }} -t {{ iperf_test_duration | default(10) }} -P {{ iperf_test_parallel | default(16) }} -f m 2>&1
  loop: "{{ iperf_test_targets | default([]) }}"
  register: iperf_raw_results
  changed_when: false
  failed_when: false
  when:
    - _iperf_version == 'iperf'
    - iperf_test_targets | default([]) | length > 0

- name: Parse iperf results (text)
  ansible.builtin.set_fact:
    iperf_results: >-
      {{
        iperf_results + [{
          'target': item.item,
          'success': item.rc == 0 and 'connect failed' not in item.stdout,
          'bandwidth_mbps': ((item.stdout | regex_search('\[SUM\].*?([0-9.]+)\s+Mbits/sec', '\1') | default(['0'], true) | first) if '[SUM]' in item.stdout else '0'),
          'output': item.stdout_lines | default([]) | last | default('No output'),
          'error': 'No route to host' if 'No route to host' in item.stdout else ('Connection refused' if 'Connection refused' in item.stdout else ('No SUM line' if '[SUM]' not in item.stdout and item.rc == 0 else ''))
        }]
      }}
  loop: "{{ iperf_raw_results.results | default([]) }}"
  loop_control:
    label: "{{ item.item | default('unknown') }}"
  when:
    - _iperf_version == 'iperf'
    - iperf_raw_results.results is defined

# ============================================================================
# Results display and validation
# ============================================================================

# Calculate statistics
- name: Calculate bandwidth statistics
  ansible.builtin.set_fact:
    _successful_results: "{{ iperf_results | selectattr('success') | list }}"
  when: iperf_results | length > 0

- name: Calculate min/max/avg bandwidth
  ansible.builtin.set_fact:
    _bandwidth_values: "{{ _successful_results | map(attribute='bandwidth_mbps') | map('float') | list }}"
  when: _successful_results | default([]) | length > 0

- name: Set bandwidth stats
  ansible.builtin.set_fact:
    _min_bandwidth: "{{ _bandwidth_values | min | round(2) }}"
    _max_bandwidth: "{{ _bandwidth_values | max | round(2) }}"
    _avg_bandwidth: "{{ ((_bandwidth_values | sum) / (_bandwidth_values | length)) | round(2) }}"
    _slowest_target: "{{ _successful_results | sort(attribute='bandwidth_mbps') | first }}"
    _fastest_target: "{{ _successful_results | sort(attribute='bandwidth_mbps') | last }}"
  when: _bandwidth_values | default([]) | length > 0

- name: Display individual test results
  ansible.builtin.debug:
    msg: |
      {{ _iperf_version | upper }} Test: {{ item.target }}
        Status: {{ 'OK' if item.success else 'FAILED' }}
        Bandwidth: {{ item.bandwidth_mbps }} Mbits/sec {{ '[BELOW MINIMUM]' if (item.bandwidth_mbps | float) < (iperf_min_bandwidth_mbps | default(180000) | float) and item.success else ('[OK]' if item.success else '') }}
        {% if item.error | default('') %}Error: {{ item.error }}{% endif %}
  loop: "{{ iperf_results }}"
  loop_control:
    label: "{{ item.target }}"
  when: iperf_results | length > 0

- name: Display iperf bandwidth summary
  ansible.builtin.debug:
    msg: |
      {{ _iperf_version | upper }} Bandwidth Test Summary:
      ============================================
      Test parameters:
        Tool: {{ _iperf_version }} (port {{ _iperf_port }})
        Duration: {{ iperf_test_duration | default(10) }} seconds
        Parallel streams: {{ iperf_test_parallel | default(16) }}
        Minimum expected: {{ iperf_min_bandwidth_mbps | default(180000) }} Mbits/sec
        Targets tested: {{ iperf_results | length }}
        Successful: {{ _successful_results | length }}
        Failed: {{ iperf_results | length - _successful_results | length }}

      Statistics (successful tests only):
        Minimum: {{ _min_bandwidth }} Mbits/sec
        Maximum: {{ _max_bandwidth }} Mbits/sec
        Average: {{ _avg_bandwidth }} Mbits/sec

      SLOWEST: {{ _slowest_target.target }} @ {{ _slowest_target.bandwidth_mbps }} Mbits/sec
      FASTEST: {{ _fastest_target.target }} @ {{ _fastest_target.bandwidth_mbps }} Mbits/sec
      ============================================
  when: _bandwidth_values | default([]) | length > 0

- name: Display failed tests summary
  ansible.builtin.debug:
    msg: |
      FAILED TESTS:
      {% for result in iperf_results | rejectattr('success') | list %}
        - {{ result.target }}: {{ result.error | default('Unknown error') }}
      {% endfor %}
  when: (iperf_results | rejectattr('success') | list | length) > 0

- name: Identify targets with low bandwidth
  ansible.builtin.set_fact:
    iperf_low_bandwidth_targets: >-
      {{
        iperf_results
        | selectattr('success')
        | selectattr('bandwidth_mbps', 'defined')
        | list
        | json_query('[?to_number(bandwidth_mbps) < `' + (iperf_min_bandwidth_mbps | default(180000) | string) + '`]')
      }}
  when: iperf_results | length > 0

- name: Warn on low bandwidth
  ansible.builtin.debug:
    msg: |
      WARNING: The following targets have bandwidth below {{ iperf_min_bandwidth_mbps | default(180000) }} Mbits/sec:
      {% for result in iperf_low_bandwidth_targets %}
        - {{ result.target }}: {{ result.bandwidth_mbps }} Mbits/sec
      {% endfor %}
  when:
    - iperf_low_bandwidth_targets is defined
    - iperf_low_bandwidth_targets | length > 0

- name: Fail on low bandwidth if enforced
  ansible.builtin.fail:
    msg: |
      ERROR: Network bandwidth below minimum threshold ({{ iperf_min_bandwidth_mbps | default(180000) }} Mbits/sec).
      Failed targets:
      {% for result in iperf_low_bandwidth_targets %}
        - {{ result.target }}: {{ result.bandwidth_mbps }} Mbits/sec
      {% endfor %}

      Check network configuration, MTU settings, and switch capacity.
      Set iperf_enforce_bandwidth: false to continue anyway.
  when:
    - iperf_enforce_bandwidth | default(false)
    - iperf_low_bandwidth_targets is defined
    - iperf_low_bandwidth_targets | length > 0

- name: Identify failed iperf connections
  ansible.builtin.set_fact:
    iperf_failed_targets: "{{ iperf_results | rejectattr('success') | list }}"
  when: iperf_results | length > 0

- name: Warn on failed iperf connections
  ansible.builtin.debug:
    msg: |
      WARNING: Could not connect to {{ _iperf_version }} server on the following targets:
      {% for result in iperf_failed_targets %}
        - {{ result.target }}: {{ result.output }}
      {% endfor %}

      Ensure {{ _iperf_version }} server is running on target:
      {% if _iperf_version == 'iperf3' %}
        iperf3 -s -D    # Listens on port 5201
      {% else %}
        iperf -s -D     # Listens on port 5001
      {% endif %}
  when:
    - iperf_failed_targets is defined
    - iperf_failed_targets | length > 0
