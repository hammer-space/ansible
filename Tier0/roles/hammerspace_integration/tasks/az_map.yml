---
# Availability Zone Mapping
# Maps nodes to AZ labels in Hammerspace
# Reference: hs_ops az_map.yml
#
# AZ detection priority:
# 1. Explicit hammerspace_node_az variable
# 2. OCI fault domain (if oci_fault_domain is defined from dynamic inventory)
# 3. AZ prefix in node name format "AZ1:node-name"
# 4. Default AZ (hammerspace_default_az)

- name: "Determine AZ for node {{ hs_node_name }}"
  ansible.builtin.set_fact:
    node_az: >-
      {%- if hammerspace_node_az is defined -%}
        {{ hammerspace_node_az }}
      {%- elif oci_fault_domain is defined and oci_fault_domain -%}
        {{ oci_fault_domain | regex_replace('FAULT-DOMAIN-', 'AZ') }}
      {%- elif ':' in hs_node_name -%}
        {{ hs_node_name.split(':')[0] }}
      {%- else -%}
        {{ hammerspace_default_az | default('default') }}
      {%- endif -%}
    node_base_name: "{{ hs_node_name.split(':')[1] if ':' in hs_node_name else hs_node_name }}"

- name: "Display AZ mapping"
  ansible.builtin.debug:
    msg: "Node '{{ hs_node_name }}' mapped to AZ: {{ node_az }}, Base name: {{ node_base_name }}"

- name: "Apply availability-zone label to node"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/nodes/{{ hs_node_name | urlencode }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: node_details
  when: hammerspace_apply_az_labels | default(false)

- name: "Build node update payload with AZ label"
  ansible.builtin.set_fact:
    node_az_payload: "{{ node_details.json | combine({'labels': (node_details.json.labels | default([])) + [{'key': 'availability-zone', 'value': node_az}]}, recursive=True) }}"
  when:
    - hammerspace_apply_az_labels | default(false)
    - node_details.json is defined

- name: "Update node with AZ label"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/nodes/{{ node_details.json.uoid.uuid }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: PUT
    body: "{{ node_az_payload }}"
    body_format: json
    force_basic_auth: true
    status_code: [200, 202]
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 180
  register: az_label_result
  when:
    - hammerspace_apply_az_labels | default(false)
    - node_az_payload is defined
    - node_az not in (node_details.json.labels | default([]) | map(attribute='value') | list)

- name: "Display AZ label status"
  ansible.builtin.debug:
    msg: >-
      AZ label for node '{{ hs_node_name }}':
      {% if az_label_result.changed | default(false) %}applied (availability-zone={{ node_az }}){% else %}already set or skipped{% endif %}
  when: hammerspace_apply_az_labels | default(false)
