---
# Task Queue Monitoring - Wait until queue is below threshold
# Prevents overwhelming the Hammerspace cluster with too many simultaneous operations
# Reference: hs_ops tasks_count.yml and tasks_executing_count.yml

- name: "Check current QUEUED task count"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/tasks?spec=status%3Deq%3DQUEUED"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: queued_tasks_result
  failed_when: false

- name: "Display current queue depth"
  ansible.builtin.debug:
    msg: "Current queued tasks: {{ queued_tasks_result.json | length | default(0) }}"
  when: hammerspace_debug | default(false)

- name: "Wait for task queue to clear (threshold: {{ hammerspace_max_queued_tasks | default(10) }})"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/tasks?spec=status%3Deq%3DQUEUED"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: task_queue_check
  until: (task_queue_check.json | length) < (hammerspace_min_queued_tasks | default(5))
  retries: "{{ hammerspace_task_queue_retries | default(100) }}"
  delay: "{{ hammerspace_task_queue_delay | default(10) }}"
  when:
    - hammerspace_task_queue_throttle | default(true)
    - (queued_tasks_result.json | length | default(0)) > (hammerspace_max_queued_tasks | default(10))

- name: "Check current EXECUTING task count"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/tasks?spec=status%3Deq%3DEXECUTING"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: executing_tasks_result
  failed_when: false
  when: hammerspace_monitor_executing_tasks | default(false)

- name: "Wait for executing tasks to complete"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/tasks?spec=status%3Deq%3DEXECUTING"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: executing_check
  until: (executing_check.json | length) < 1
  retries: "{{ hammerspace_task_queue_retries | default(100) }}"
  delay: "{{ hammerspace_task_queue_delay | default(10) }}"
  when:
    - hammerspace_monitor_executing_tasks | default(false)
    - hammerspace_wait_for_executing | default(false)
    - (executing_tasks_result.json | length | default(0)) > 0

- name: "Display task queue status"
  ansible.builtin.debug:
    msg: >-
      Task Queue Status - QUEUED: {{ task_queue_check.json | length | default(queued_tasks_result.json | length | default(0)) }},
      EXECUTING: {{ executing_tasks_result.json | length | default('N/A') }}
  when: hammerspace_debug | default(false)
