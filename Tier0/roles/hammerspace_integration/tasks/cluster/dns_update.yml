---
# Update DNS Configuration
# Called from main.yml with dns_config variable
# Reference: hs_ops dns_update.yml

- name: "Get current DNS configuration"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/dnss"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: current_dns

- name: "Build DNS update payload"
  ansible.builtin.set_fact:
    dns_payload:
      primaryDnsServer: "{{ dns_config.primary_server }}"
      secondaryDnsServer: "{{ dns_config.secondary_server | default('') }}"
      searchDomains: "{{ dns_config.search_domains | default([]) }}"

- name: "Update DNS configuration"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/dnss/{{ current_dns.json[0].uoid.uuid }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: PUT
    body: "{{ current_dns.json[0] | combine(dns_payload, recursive=True) }}"
    body_format: json
    force_basic_auth: true
    status_code: [200, 202]
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 180
  register: dns_update_result
  when:
    - dns_config.primary_server is defined
    - current_dns.json | length > 0

- name: "Display DNS update status"
  ansible.builtin.debug:
    msg: >-
      DNS configuration updated:
      Primary={{ dns_config.primary_server }},
      Secondary={{ dns_config.secondary_server | default('none') }},
      Search domains={{ dns_config.search_domains | default([]) | join(', ') }}
