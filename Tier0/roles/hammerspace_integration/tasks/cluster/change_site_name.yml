---
# Change Cluster Site Name
# Called from main.yml with site_config variable
# Reference: hs_ops cluster_change_site_name.yml

- name: "Get current site configuration"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/sites/local"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: current_site

- name: "Check if site name needs update"
  ansible.builtin.set_fact:
    site_name_changed: "{{ current_site.json.name != site_config.name }}"

- name: "Update site name to {{ site_config.name }}"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/sites/local"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: PUT
    body: "{{ current_site.json | combine({'name': site_config.name}, recursive=True) }}"
    body_format: json
    force_basic_auth: true
    status_code: [200, 202]
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 180
  register: site_update_result
  when: site_name_changed

- name: "Wait for site name update to complete"
  ansible.builtin.uri:
    url: "{{ site_update_result.location }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
  register: site_update_status
  until: site_update_status.json.status == "COMPLETED"
  retries: 30
  delay: 5
  when: site_update_result.location is defined

- name: "Display site name update status"
  ansible.builtin.debug:
    msg: >-
      Site name:
      {% if not site_name_changed %}already set to '{{ site_config.name }}'{% else %}updated to '{{ site_config.name }}'{% endif %}
