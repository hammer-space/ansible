---
# Set Cluster Physical Location
# Called from main.yml with location_config variable
# Reference: hs_ops cluster_set_location.yml

- name: "Get current cluster controller configuration"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/cntl"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 60
  register: current_cntl

- name: "Build location update payload"
  ansible.builtin.set_fact:
    location_payload:
      physicalLocation:
        datacenter: "{{ location_config.datacenter | default('') }}"
        room: "{{ location_config.room | default('') }}"
        row: "{{ location_config.row | default('') }}"
        rack: "{{ location_config.rack | default('') }}"
        position: "{{ location_config.position | default('') }}"

- name: "Update cluster location"
  ansible.builtin.uri:
    url: "{{ hs_api_url }}/cntl/{{ current_cntl.json[0].uoid.uuid }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: PUT
    body: "{{ current_cntl.json[0] | combine(location_payload, recursive=True) }}"
    body_format: json
    force_basic_auth: true
    status_code: [200, 202]
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
    timeout: 180
  register: location_update_result
  when: current_cntl.json | length > 0

- name: "Wait for location update to complete"
  ansible.builtin.uri:
    url: "{{ location_update_result.location }}"
    user: "{{ hammerspace_api_user }}"
    password: "{{ hammerspace_api_password }}"
    method: GET
    force_basic_auth: true
    status_code: 200
    validate_certs: "{{ hammerspace_api_validate_certs | default(false) }}"
  register: location_update_status
  until: location_update_status.json.status == "COMPLETED"
  retries: 30
  delay: 5
  when: location_update_result.location is defined

- name: "Display location update status"
  ansible.builtin.debug:
    msg: >-
      Cluster location updated:
      Datacenter={{ location_config.datacenter | default('N/A') }},
      Room={{ location_config.room | default('N/A') }},
      Rack={{ location_config.rack | default('N/A') }}
