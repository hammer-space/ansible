---
# RAID setup role - main tasks

- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution | lower }}-{{ ansible_distribution_major_version }}.yml"
    - "{{ ansible_distribution | lower }}.yml"
    - "{{ ansible_os_family | lower }}.yml"
    - "default.yml"

- name: Install mdadm package
  ansible.builtin.package:
    name: mdadm
    state: present

- name: Gather existing RAID array information
  ansible.builtin.command: cat /proc/mdstat
  register: mdstat_output
  changed_when: false
  failed_when: false

- name: Check for existing RAID arrays
  ansible.builtin.set_fact:
    existing_arrays: "{{ mdstat_output.stdout | regex_findall('md[0-9]+') | unique }}"

- name: Display existing RAID arrays
  ansible.builtin.debug:
    msg: "Existing RAID arrays: {{ existing_arrays }}"
  when: existing_arrays | length > 0

- name: Verify drives exist before creating RAID
  ansible.builtin.stat:
    path: "{{ item.1 }}"
  loop: "{{ raid_arrays | subelements('drives') }}"
  loop_control:
    label: "{{ item.1 }}"
  register: drive_checks

- name: Fail if any drives are missing
  ansible.builtin.fail:
    msg: "Drive {{ item.item.1 }} does not exist!"
  loop: "{{ drive_checks.results }}"
  loop_control:
    label: "{{ item.item.1 }}"
  when: not item.stat.exists

- name: Check if drives are already in use
  ansible.builtin.command: "lsblk -no TYPE {{ item.1 }}"
  loop: "{{ raid_arrays | subelements('drives') }}"
  loop_control:
    label: "{{ item.1 }}"
  register: drive_usage
  changed_when: false
  failed_when: false

- name: Warn about drives already in RAID
  ansible.builtin.debug:
    msg: "WARNING: {{ item.item.1 }} appears to be part of a RAID array"
  loop: "{{ drive_usage.results }}"
  loop_control:
    label: "{{ item.item.1 }}"
  when: "'raid' in item.stdout"

- name: Create RAID arrays
  ansible.builtin.command: >
    mdadm --create --verbose {{ item.device }}
    --level={{ item.level }}
    --raid-devices={{ item.drives | length }}
    {% if raid_chunk_size is defined and item.level in [0, 5, 6, 10] %}--chunk={{ raid_chunk_size }}{% endif %}
    {{ item.drives | join(' ') }}
    --run
  loop: "{{ raid_arrays }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - item.name not in existing_arrays
    - force_raid_recreate | default(false) or item.name not in existing_arrays
  register: raid_creation
  # mdadm may prompt - using --run to skip
  # chunk size is auto-tuned based on CPU if cpu_optimized_raid: true

- name: Wait for RAID arrays to sync (for mirrored/parity arrays)
  ansible.builtin.command: cat /proc/mdstat
  register: sync_status
  until: "'resync' not in sync_status.stdout and 'recovery' not in sync_status.stdout"
  retries: 60
  delay: 30
  changed_when: false
  when: raid_arrays | selectattr('level', 'in', [1, 5, 6, 10]) | list | length > 0

- name: Ensure /etc/mdadm directory exists
  ansible.builtin.file:
    path: /etc/mdadm
    state: directory
    mode: '0755'

- name: Get current mdadm array details
  ansible.builtin.command: mdadm --detail --scan
  register: mdadm_scan
  changed_when: false

- name: Generate mdadm.conf with proper settings
  ansible.builtin.copy:
    content: |
      # mdadm.conf - Generated by Ansible
      # Auto-generated on {{ ansible_date_time.iso8601 }}

      # Email for RAID monitoring alerts (optional)
      MAILADDR root

      # Automatically assemble arrays at boot
      AUTO +all

      # RAID array definitions
      {{ mdadm_scan.stdout }}
    dest: "{{ mdadm_conf_path | default('/etc/mdadm/mdadm.conf') }}"
    mode: '0644'
    backup: true
  notify: update initramfs

- name: Symlink mdadm.conf to /etc for RedHat compatibility
  ansible.builtin.file:
    src: /etc/mdadm/mdadm.conf
    dest: /etc/mdadm.conf
    state: link
    force: true
  when: ansible_os_family == 'RedHat'

- name: Ensure mdadm service is enabled for monitoring
  ansible.builtin.systemd:
    name: "{{ mdadm_monitor_service | default('mdmonitor') }}"
    enabled: true
    state: started
  failed_when: false

- name: Flush handlers to update initramfs now
  ansible.builtin.meta: flush_handlers

- name: Display RAID array status
  ansible.builtin.command: cat /proc/mdstat
  register: final_mdstat
  changed_when: false

- name: Show RAID status
  ansible.builtin.debug:
    var: final_mdstat.stdout_lines
