#!/bin/bash
# Hammerspace Auto-Remount Check Script
# Checks and remounts Hammerspace volumes if accidentally unmounted
# Generated by Ansible - do not edit manually

set -euo pipefail

MOUNT_BASE="{{ mount_base_path | default('/hammerspace') }}"
LOG_TAG="hammerspace-remount"

log() {
    logger -t "$LOG_TAG" "$*"
}

# Get list of expected mount points from fstab
get_expected_mounts() {
    grep -E "^\s*[^#].*\s+${MOUNT_BASE}/[^ ]+" /etc/fstab | awk '{print $2}' || true
}

# Check if a path is currently mounted
is_mounted() {
    mountpoint -q "$1" 2>/dev/null
}

# Main check loop
main() {
    local remounted=0
    local failed=0

    for mount_path in $(get_expected_mounts); do
        if [ ! -d "$mount_path" ]; then
            log "WARNING: Mount point directory $mount_path does not exist"
            continue
        fi

        if ! is_mounted "$mount_path"; then
            log "Mount $mount_path is not mounted, attempting remount..."

            # Try to mount using systemctl (triggers automount if configured)
            if systemctl start "$(systemd-escape -p "$mount_path").automount" 2>/dev/null; then
                # Touch the directory to trigger automount
                if ls "$mount_path" >/dev/null 2>&1 && is_mounted "$mount_path"; then
                    log "Successfully remounted $mount_path via automount"
                    ((remounted++)) || true
                else
                    log "Automount triggered but mount not successful for $mount_path"
                    ((failed++)) || true
                fi
            elif mount "$mount_path" 2>/dev/null; then
                log "Successfully remounted $mount_path via mount command"
                ((remounted++)) || true
            else
                log "ERROR: Failed to remount $mount_path"
                ((failed++)) || true
            fi
        fi
    done

    if [ $remounted -gt 0 ] || [ $failed -gt 0 ]; then
        log "Remount check complete: $remounted remounted, $failed failed"
    fi
}

main "$@"
